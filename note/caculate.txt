<?php
session_start();

class FirstTimetableObj {
    public $day, $time;
    function __construct($day, $time) {
        $this->day = $day;
        $this->time = $time;
    }
}

class SecondTimetableObj {
    public $scode, $sname, $day1, $time1, $day2, $time2;
    function __construct($scode, $sname, $day1, $time1, $day2, $time2) {
        $this->scode = $scode;
        $this->sname = $sname;
        $this->day1 = $day1;
        $this->time1 = $time1;
        $this->day2 = $day2;
        $this->time2 = $time2;
    }
}

class ThirdTimetableObj {
    public $scode1, $sname1, $dt1, $dt2;
    function __construct($scode1, $sname1, $dt1, $dt2) {
        $this->scode1 = $scode1;
        $this->sname1 = $sname1;
        $this->dt1 = $dt1;
        $this->dt2 = $dt2;
    }
}

$_SESSION['countSubject'] = $_POST['countSubject'];
$_SESSION['countPeriodperDay'] = $_POST['countPeriodperDay'];
$countSubject = $_SESSION['countSubject'];
$countTime = $_SESSION['countPeriodperDay'];

// Generate weekdays and periods
$days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
$timetable = [];

foreach ($days as $day) {
    $slots = [];
    for ($i = 1; $i <= $countTime; $i++) {
        $slots[] = new FirstTimetableObj($day, $i);
    }
    $timetable[] = $slots;
}

function shuffle_recursive(&$arr) {
    shuffle($arr);
    foreach ($arr as &$v) {
        if (is_array($v)) shuffle($v);
    }
}

$firstDay = $firstTime = $secondDay = $secondTime = [];

for ($i = 0; $i < $countSubject; $i++) {
    // Assign first slot
    do {
        shuffle_recursive($timetable);
        $slot = $timetable[0][0];
    } while ($slot->day === "NoData");

    $firstDay[$i] = $slot->day;
    $firstTime[$i] = $slot->time;
    $timetable[0][0] = new FirstTimetableObj("NoData", 7);

    // Assign second slot (not same day or time)
    do {
        shuffle_recursive($timetable);
        $slot = $timetable[0][0];
    } while (
        $slot->day === "NoData" || $slot->time === 7 ||
        $slot->day === $firstDay[$i] || $slot->time === $firstTime[$i]
    );

    $secondDay[$i] = $slot->day;
    $secondTime[$i] = $slot->time;
    $timetable[0][0] = new FirstTimetableObj("NoData", 7);
}

// Display table
echo "<html><body><font face='Times New Roman'><style>
    input[type=submit] { padding: 5px 30px; background: #586e75; border: #485c61 1px solid; color: #FFF; border-radius: 2px; cursor: pointer; margin-left: 20px; margin-bottom: 5px; }
    th, td { border-style: groove; } th { background-color: #f2f2f2; color: black; } tr:hover { background-color: #f2f2f2; }
    body { background-color: #DBF9FC; font-size: 16px; }
</style>";

$scode = $sname = [];
foreach ($_SESSION['result1'] as $i => $data) {
    $scode[$i] = $data['scode'];
    $sname[$i] = $data['sname'];
}

echo "<table width='50%' border='2' cellspacing='0'>
    <thead><tr><th bgcolor='green'>Subject Code</th><th>Subject Name</th><th>First Day and Time</th><th>Second Day and Time</th></tr></thead><tbody>";

for ($i = 0; $i < $countSubject; $i++) {
    $dt1 = $firstDay[$i] . "($firstTime[$i])";
    $dt2 = $secondDay[$i] . "($secondTime[$i])";
    echo "<tr><td align='center'>{$scode[$i]}</td><td align='center'>{$sname[$i]}</td><td align='center'>$dt1</td><td align='center'>$dt2</td></tr>";
    $_SESSION['scode1'][] = $scode[$i];
    $_SESSION['sname1'][] = $sname[$i];
    $_SESSION['dt1'][] = $dt1;
    $_SESSION['dt2'][] = $dt2;
}
echo "</tbody></table><br>";

// Print remaining "Self Study" slots
foreach ($timetable as $daySlots) {
    foreach ($daySlots as $slot) {
        if ($slot->day !== "NoData") {
            echo "Self Study = {$slot->day}, {$slot->time}<br>";
        }
    }
}

echo "<p>Total subject in this table: $countSubject</p>
<form>
    <input type='submit' name='back' value='BACK' formaction='calculateTeacher.php' />
    <input type='submit' name='next page' value='NEXT PAGE' formaction='2timeDesign.php' />
</form></font></body></html>";
?>
